# @configure_input@ 

root ?= /scratch/mulhern/cbiexp
tooldir ?= $(root)/src/lsa
MATLAB = matlab 

runsinfo.mat: X.sparse f.indices s.indices
	$(MATLAB) -r "path(path, '$(tooldir)'); convertData()" > /dev/null

initialize : runsinfo.mat

numbugaspects := $(if $(numbugaspects),$(numbugaspects),0)
expdir := $(numaspects)t_$(numbugaspects)b

numrestarts := $(if $(numrestarts),$(numrestarts),0)

prepare_experiment: runsinfo.mat
	mkdir $(expdir)
	echo 'numaspects = $(numaspects)' > $(expdir)/GNUmakefile
	echo 'numbugaspects = $(numbugaspects)' >> $(expdir)/GNUmakefile
	echo 'numrestarts = $(numrestarts)' >> $(expdir)/GNUmakefile
	echo 'include $(tooldir)/plsa/analysis-rules.mk' >> $(expdir)/GNUmakefile

	echo 'function Learn = configure()' > $(expdir)/configure.m
	echo '	Learn.K = $(numaspects);' >> $(expdir)/configure.m
	echo '	Learn.Kb = $(numbugaspects);' >> $(expdir)/configure.m
	echo '	Learn.Normalized = 1;' >> $(expdir)/configure.m  
	echo '	Learn.Max_Iterations = 100;' >> $(expdir)/configure.m
	echo '	Learn.Min_Likelihood_Change = 1;' >> $(expdir)/configure.m

prepare_subdirs:
	$(tooldir)/setup.py $(numaspects) $(numbugaspects) $(numrestarts) 

loglikelihoods.txt best:
	$(tooldir)/rank.py $(numrestarts)

rank: loglikelihoods.txt best

results.mat loglikelihood.txt:
	ln ../../runsinfo.mat
	ln ../configure.m
	$(MATLAB) -r "path(path, '$(tooldir)'); runOnce()" > /dev/null
	touch results.mat
	touch loglikelihood.txt

run: results.mat loglikelihood.txt
