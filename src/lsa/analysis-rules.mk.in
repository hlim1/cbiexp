# @configure_input@ 

root ?= /scratch/mulhern/cbiexp
tooldir ?= $(root)/src/lsa
xmldir ?= $(tooldir)/xml
MATLAB = matlab -nodisplay

runsinfo.mat: X.sparse f.indices s.indices
	$(MATLAB) -r "path(path, '$(tooldir)'); convertData()" > /dev/null

initialize : runsinfo.mat

numbugaspects := $(if $(numbugaspects),$(numbugaspects),0)
numaspects := $(if $(numaspects),$(numaspects),0)
expdir := $(numaspects)t_$(numbugaspects)b

numrestarts := $(if $(numrestarts),$(numrestarts),0)

prepare_experiment: runsinfo.mat
	mkdir $(expdir)
	echo 'numaspects = $(numaspects)' > $(expdir)/GNUmakefile
	echo 'numbugaspects = $(numbugaspects)' >> $(expdir)/GNUmakefile
	echo 'numrestarts = $(numrestarts)' >> $(expdir)/GNUmakefile
	echo 'include $(tooldir)/analysis-rules.mk' >> $(expdir)/GNUmakefile

	echo 'function Learn = configure()' > $(expdir)/configure.m
	echo '	Learn.K = $(numaspects);' >> $(expdir)/configure.m
	echo '	Learn.Kb = $(numbugaspects);' >> $(expdir)/configure.m
	echo '	Learn.Normalized = 1;' >> $(expdir)/configure.m  
	echo '	Learn.Max_Iterations = 100;' >> $(expdir)/configure.m
	echo '	Learn.Min_Likelihood_Change = 1;' >> $(expdir)/configure.m

prepare_subdirs:
	$(tooldir)/setup.py $(numaspects) $(numbugaspects) $(numrestarts) 

loglikelihoods.txt best:
	$(tooldir)/rank.py $(numrestarts)

rank: loglikelihoods.txt best

results.mat loglikelihood.txt:
	ln ../../runsinfo.mat
	ln ../configure.m
	$(MATLAB) -r "path(path, '$(tooldir)'); runOnce()" > /dev/null
	touch results.mat
	touch loglikelihood.txt

html/rawsummary.xml: results.mat runsinfo.mat clusters.mat configure.m
	$(MATLAB) -r "path(path, '$(xmldir)'); summarize()" > /dev/null
	mv rawsummary.xml html/rawsummary.xml

run: results.mat loglikelihood.txt html/rawsummary.xml

summary.xml: rawsummary.xml
	xsltproc --path $(xmldir) --output summary.xml idify.xsl rawsummary.xml

summary.html: summary.xml
	xsltproc --path $(xmldir) --path $(root)/src --path ../../../.. --stringparam source-dir ../../../../src --output summary.html summary.xsl summary.xml

html: summary.html
